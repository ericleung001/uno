<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNO Online Final v6</title>
    <style>
        body { font-family: 'Arial', sans-serif; background: #1e272e; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* é¡è‰²é¸æ“‡å½ˆçª— */
        #color-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 300; justify-content: center; align-items: center; flex-direction: column; }
        #color-options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .color-btn { width: 120px; height: 120px; border-radius: 20px; border: 5px solid rgba(255,255,255,0.8); cursor: pointer; transition: transform 0.1s; }
        .color-btn:active { transform: scale(0.9); }
        .color-btn.disabled { opacity: 0.1; pointer-events: none; filter: grayscale(100%); cursor: not-allowed; }
        .btn-red { background: #ff5555; } .btn-blue { background: #5555ff; } .btn-green { background: #55aa55; } .btn-yellow { background: #ffaa00; }

        /* éŠæˆ²çµæŸå½ˆçª— */
        #game-over-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
        #winner-text { font-size: 40px; color: #f1c40f; margin-bottom: 20px; font-weight: bold; }
        #back-lobby-btn { padding: 15px 40px; font-size: 20px; background: #2ecc71; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }

        /* é€šçŸ¥èˆ‡èŠå¤©å®¤ */
        #notification-bar { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: rgba(255, 165, 2, 0.95); color: black; padding: 12px 25px; border-radius: 30px; font-weight: bold; font-size: 18px; z-index: 200; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5); white-space: nowrap; }

        #chat-wrapper { position: fixed; bottom: 20px; right: 20px; z-index: 800; display: flex; flex-direction: column; align-items: flex-end; }
        #chat-toggle-btn { width: 60px; height: 60px; border-radius: 50%; background: #3498db; color: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; font-size: 30px; display: flex; justify-content: center; align-items: center; position: relative; }
        #chat-unread { position: absolute; top: 0; right: 0; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: none; justify-content: center; align-items: center; }
        #chat-box { width: 300px; height: 400px; background: rgba(30, 39, 46, 0.95); border-radius: 15px; border: 2px solid #576574; display: none; flex-direction: column; overflow: hidden; margin-bottom: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        #chat-header { padding: 10px; background: #34495e; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        #chat-close { cursor: pointer; font-size: 20px; }
        #chat-messages { flex: 1; padding: 10px; overflow-y: auto; font-size: 14px; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
        .msg.mine { align-self: flex-end; background: #3498db; color: white; border-bottom-right-radius: 2px; }
        .msg.others { align-self: flex-start; background: #576574; color: white; border-bottom-left-radius: 2px; }
        .msg .name { font-size: 10px; opacity: 0.7; margin-bottom: 2px; display: block; }
        #chat-input-area { padding: 10px; background: #34495e; display: flex; gap: 5px; }
        #chat-input { flex: 1; padding: 8px; border-radius: 20px; border: none; outline: none; }
        #chat-send { padding: 8px 15px; background: #2ecc71; border: none; border-radius: 20px; color: white; cursor: pointer; font-weight: bold; }

        /* ç™»å…¥ç•«é¢ */
        #login-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: #2f3640; z-index:99; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        #join-form { display: flex; flex-direction: column; align-items: center; }
        input { padding:12px; font-size:18px; margin:8px; text-align:center; border-radius: 8px; border:none; width: 220px; outline: none; }
        button { padding:12px 30px; font-size:18px; background:#e67e22; color:white; border:none; border-radius:8px; cursor:pointer; font-weight: bold; margin-top: 10px; }
        #leave-btn { background: #e74c3c; margin-left: 10px; display: none; }
        #lobby-list { margin-top: 30px; width: 320px; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; }
        .room-item { background: #34495e; margin: 8px 0; padding: 12px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .room-item:hover { background: #46637f; }
        .room-item.full { opacity: 0.5; cursor: not-allowed; }
        .room-status { font-size: 12px; padding: 4px 10px; border-radius: 12px; }
        .status-wait { background: #2ecc71; color: white; }
        .status-play { background: #e74c3c; color: white; }

        /* éŠæˆ²ç•«é¢ */
        #game-screen { display: none; flex-direction: column; height: 100%; }
        #opponents { flex:1; display:flex; justify-content:center; align-items:center; gap:10px; padding:10px; background:#2f3640; flex-wrap: wrap; overflow-y: auto; }
        .opp { background:#353b48; padding:8px 12px; border-radius:10px; min-width:80px; text-align:center; position:relative; }
        .opp.active { border:3px solid #fbc531; box-shadow:0 0 15px #fbc531; transform: scale(1.05); background: #404b5c; }

        #center { flex:2; display:flex; justify-content:center; align-items:center; gap:40px; position:relative; flex-direction: row; }
        #direction-indicator { position:absolute; top:20px; font-size:20px; color:#7f8fa6; font-weight: bold; }

        #my-area { flex:1.5; background:#191f26; padding:10px; display:flex; flex-direction:column; justify-content:flex-end; position: relative; }
        #my-hand { display:flex; overflow-x:auto; padding:10px; gap:-15px; height: 160px; align-items: center; transition: opacity 0.2s; }
        #my-hand.processing { opacity: 0.5; pointer-events: none; }
        .card.selected { transform: translateY(-40px) !important; border-color: #00ff00 !important; box-shadow: 0 0 20px #00ff00 !important; z-index: 200; }
        
        #play-action-btn { position: absolute; bottom: 200px; left: 50%; transform: translateX(-50%); background: #2ecc71; color: white; padding: 15px 40px; font-size: 22px; border-radius: 50px; border: 4px solid white; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.6); z-index: 500; display: none; }
        #play-action-btn:active { transform: translateX(-50%) scale(0.95); }

        .card { width: 90px; height: 135px; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: 800; font-size: 42px; border: 5px solid white; box-shadow: 3px 3px 10px rgba(0,0,0,0.6); cursor: pointer; flex-shrink: 0; margin-right: 8px; text-shadow: 2px 2px 0 #000; position: relative; font-family: 'Arial Black', sans-serif; }
        .card:hover { transform: translateY(-25px); z-index:100; }
        .card small { font-size: 14px; margin-top: -5px; color: white; }
        .red { background: #ff5555; } .blue { background: #5555ff; } .green { background: #55aa55; } .yellow { background: #ffaa00; } .black { background: #000; border-color: #fff; background-image: linear-gradient(135deg, #222 25%, #000 25%, #000 50%, #222 50%, #222 75%, #000 75%, #000 100%); background-size: 10px 10px; }
        .back { background: repeating-linear-gradient(45deg, #1e272e, #1e272e 10px, #2f3640 10px, #2f3640 20px); color: white; border: 4px solid #7f8fa6; font-size: 20px; text-shadow: none; }
        .back.penalty { border-color: #e74c3c; box-shadow: 0 0 20px #e74c3c; color: #e74c3c; }

        #status-bar { text-align: center; font-size: 20px; margin-bottom: 10px; min-height: 30px; font-weight: bold; }
        .current-color-hint { position: absolute; bottom: -50px; background: rgba(0,0,0,0.8); padding: 8px 20px; border-radius: 20px; font-size: 16px; border: 1px solid white; }
        
        /* === ä¿®æ­£ï¼šå³ä¸Šè§’æˆ¿é–“è³‡è¨Šèˆ‡é€€å‡ºæŒ‰éˆ•æ¨£å¼ === */
        #room-info { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; /* é å³å°é½Š */
            gap: 5px;
        }
        #room-text { font-size: 16px; color: #7f8fa6; font-weight: bold; }
        #exit-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        #exit-btn:hover { background: #c0392b; }
    </style>
</head>
<body>

    <div id="color-modal">
        <h2 style="margin-bottom: 30px; font-size: 28px;">è«‹é¸æ“‡ä¸»è¦é¡è‰²</h2>
        <div id="color-options">
            <div id="modal-btn-red" class="color-btn btn-red" onclick="selectColor('red')"></div>
            <div id="modal-btn-blue" class="color-btn btn-blue" onclick="selectColor('blue')"></div>
            <div id="modal-btn-green" class="color-btn btn-green" onclick="selectColor('green')"></div>
            <div id="modal-btn-yellow" class="color-btn btn-yellow" onclick="selectColor('yellow')"></div>
        </div>
        <button onclick="closeColorModal()" style="margin-top: 30px; background: #7f8fa6; padding:10px 20px;">å–æ¶ˆ</button>
    </div>

    <div id="game-over-modal">
        <div id="winner-text"></div>
        <button id="back-lobby-btn" onclick="backToLobby()">è¿”å›å¤§å»³</button>
    </div>

    <div id="notification-bar"></div>

    <div id="chat-wrapper" style="display: none;">
        <div id="chat-box">
            <div id="chat-header">
                <span>ğŸ’¬ èŠå¤©å®¤</span>
                <span id="chat-close" onclick="toggleChat()">âœ•</span>
            </div>
            <div id="chat-messages"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="handleChatKey(event)">
                <button id="chat-send" onclick="sendChat()">é€å‡º</button>
            </div>
        </div>
        <button id="chat-toggle-btn" onclick="toggleChat()">
            ğŸ’¬
            <div id="chat-unread"></div>
        </button>
    </div>

    <div id="login-screen">
        <h1 style="font-size: 50px; margin-bottom: 20px;">UNO <span style="color:#ffaa00">Online</span></h1>
        <div id="join-form">
            <input type="text" id="room-id" placeholder="è¼¸å…¥æˆ¿è™Ÿ æˆ– é»æ“Šä¸‹æ–¹">
            <input type="text" id="username" placeholder="ä½ çš„æš±ç¨±">
            <button onclick="submitJoin()">åŠ å…¥ / å‰µå»ºæˆ¿é–“</button> 
        </div>
        <p id="wait-msg" style="color:#aaa; margin-top:20px; display:none;"></p>
        <div style="display:flex; justify-content:center;">
            <button id="start-btn" onclick="startGameAction()" style="display:none; background:#55aa55;">é–‹å§‹éŠæˆ²</button>
            <button id="leave-btn" onclick="leaveGameAction()" style="display:none; background: #e74c3c; margin-left: 10px;">é€€å‡ºæˆ¿é–“</button>
        </div>
        <h3 style="margin-top:30px; color:#aaa;">ğŸ“‹ å¤§å»³æˆ¿é–“åˆ—è¡¨</h3>
        <div id="lobby-list"><div style="color:#777; font-size:14px;">é€£æ¥ä¸­...</div></div>
    </div>

    <div id="game-screen">
        <div id="room-info">
            <div id="room-text">Room: <span id="current-room-display"></span></div>
            <button id="exit-btn" onclick="backToLobby()">é€€å‡ºæˆ¿é–“</button>
        </div>

        <div id="opponents"></div>
        <div id="center">
            <div id="direction-indicator">é †æ™‚é‡ â†»</div>
            <div id="draw-btn" class="card back" onclick="drawCardAction()">
                <div id="draw-text">PASS</div>
                <small id="draw-sub">(æŠ½ç‰Œ)</small>
            </div>
            <div style="position:relative">
                <div id="discard" class="card"></div>
                <div id="color-hint" class="current-color-hint" style="display:none"></div>
            </div>
        </div>
        <div id="my-area">
            <button id="play-action-btn" onclick="confirmPlay()">ç¢ºèªå‡ºç‰Œ</button>
            <div id="status-bar">æº–å‚™é–‹å§‹</div>
            <div id="my-hand"></div>
        </div>
    </div>

    <script src="https://uno.ttctv-105.cc/socket.io/socket.io.js"></script>

    <script>
        let socket = null;
        let myId = null;
        let isProcessing = false;
        let selectedCards = new Set();
        let pendingPlayData = null;
        let unreadCount = 0;
        let lastActivePlayer = null;
        let currentActiveColor = null; 

        const dingSound = new Audio("ding.mp3");
        dingSound.load();

        function unlockAudio() {
            dingSound.play().then(() => {
                dingSound.pause();
                dingSound.currentTime = 0;
            }).catch(() => {});
        }

        window.onload = function() {
            if(localStorage.getItem('last_room')) document.getElementById('room-id').value = localStorage.getItem('last_room');
            if(localStorage.getItem('last_name')) document.getElementById('username').value = localStorage.getItem('last_name');
        }

        function playTurnSound() {
            dingSound.currentTime = 0;
            dingSound.play().catch(e => console.log("Sound error:", e));
        }

        function toggleChat() {
            const box = document.getElementById('chat-box');
            const btn = document.getElementById('chat-toggle-btn');
            if (box.style.display === 'flex') {
                box.style.display = 'none';
                btn.style.display = 'flex';
            } else {
                box.style.display = 'flex';
                btn.style.display = 'none';
                unreadCount = 0;
                updateUnreadBadge();
                scrollToBottom();
            }
        }
        function handleChatKey(e) { if (e.key === 'Enter') sendChat(); }
        function sendChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text && socket) {
                socket.emit('sendMessage', text);
                input.value = '';
            }
        }
        function appendMessage(name, text, isMine) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `msg ${isMine ? 'mine' : 'others'}`;
            let nameHtml = isMine ? '' : `<span class="name">${name}</span>`;
            div.innerHTML = `${nameHtml}${escapeHtml(text)}`;
            container.appendChild(div);
            scrollToBottom();
            const box = document.getElementById('chat-box');
            if (box.style.display !== 'flex') {
                unreadCount++;
                updateUnreadBadge();
            }
        }
        function updateUnreadBadge() {
            const badge = document.getElementById('chat-unread');
            if (unreadCount > 0) {
                badge.innerText = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        function scrollToBottom() {
            const div = document.getElementById('chat-messages');
            div.scrollTop = div.scrollHeight;
        }
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function backToLobby() { location.reload(); }

        function submitJoin() {
            unlockAudio();
            if(!socket) return alert("å°šæœªé€£æ¥åˆ°ä¼ºæœå™¨");
            const roomId = document.getElementById('room-id').value.trim();
            const name = document.getElementById('username').value.trim();
            if(!roomId || !name) return alert("è«‹è¼¸å…¥æˆ¿è™Ÿå’Œæš±ç¨±");
            localStorage.setItem('last_room', roomId);
            localStorage.setItem('last_name', name);
            socket.emit('joinGame', { name, roomId });
        }

        function leaveGameAction() { if(socket) socket.emit('leaveGame'); }
        function startGameAction() { if(socket) socket.emit('startGame'); }
        function drawCardAction() { if(socket && !isProcessing) { lockInterface(); socket.emit('drawCard'); } }

        function toggleCardSelection(cardId, element) {
            if (isProcessing) return;
            if (selectedCards.has(cardId)) {
                selectedCards.delete(cardId);
                element.classList.remove('selected');
            } else {
                selectedCards.add(cardId);
                element.classList.add('selected');
            }
            updatePlayButton();
        }

        function updatePlayButton() {
            const btn = document.getElementById('play-action-btn');
            if (selectedCards.size > 0) {
                btn.style.display = 'block';
                btn.innerText = `å‡ºç‰Œ (${selectedCards.size})`;
            } else {
                btn.style.display = 'none';
            }
        }

        // ============================================
        // === æœ€çµ‚ç¢ºèªå‡ºç‰Œé‚è¼¯ (Wild ç„¡é™ + é€£æ“Šéæ¿¾) ===
        // ============================================
        function confirmPlay() {
            if (selectedCards.size === 0) return;
            const cardIds = Array.from(selectedCards);
            const cards = cardIds.map(id => window.myHandData.find(c => c.id === id)).filter(c => c);

            // 1. æª¢æŸ¥æ•¸å­—/åŠŸèƒ½æ˜¯å¦ä¸€è‡´
            if (cards.length > 1) {
                const firstVal = cards[0].value;
                const allSame = cards.every(c => c.value === firstVal);
                if (!allSame) {
                    alert("é€£æ“Šå¤±æ•—ï¼šä½ é¸çš„ç‰Œæ•¸å­—æˆ–åŠŸèƒ½ä¸ç›¸åŒï¼");
                    return; 
                }
            }

            const hasBlack = cards.some(c => c.color === 'black');
            const distinctPlayColors = [...new Set(cards.filter(c => c.color !== 'black').map(c => c.color))];
            
            // 2. åˆ¤æ–·æ˜¯å¦éœ€è¦å½ˆå‡ºé¡è‰²é¸æ“‡è¦–çª—
            let needsColorSelection = false;

            // æ¢ä»¶ A: æœ‰é»‘ç‰Œ (Wild) -> å¿…é ˆé¸è‰²
            if (hasBlack) {
                needsColorSelection = true;
            }
            // æ¢ä»¶ B: å¤šå¼µç‰Œé€£æ“Š (å³ä½¿é¡è‰²å–®ä¸€ï¼Œç‚ºäº†åŸ·è¡Œéæ¿¾é‚è¼¯ï¼Œä¹Ÿè¦–ç‚ºéœ€è¦é¸è‰²)
            else if (cardIds.length > 1) {
                needsColorSelection = true;
            }

            if (needsColorSelection) {
                pendingPlayData = cardIds;
                
                let allowedColors = [];
                
                // æ­¥é©Ÿ A: æ±ºå®šåŸºç¤å€™é¸é¡è‰²
                if (hasBlack) {
                    allowedColors = ['red', 'blue', 'green', 'yellow'];
                } else {
                    allowedColors = [...distinctPlayColors];
                }

                // æ­¥é©Ÿ B: åŸ·è¡Œã€Œä¸å¯å›é¦¬æ§ã€éæ¿¾ (Wild å…æ­»é‡‘ç‰Œ)
                // åªæœ‰åœ¨ã€Œæ²’æœ‰ Wild å¡ã€çš„æƒ…æ³ä¸‹æ‰éæ¿¾
                if (!hasBlack && currentActiveColor && currentActiveColor !== 'black') {
                    allowedColors = allowedColors.filter(c => c !== currentActiveColor);
                }

                showColorModal(allowedColors);

            } else {
                // ä¸éœ€è¦é¸è‰²ï¼Œç›´æ¥å‡ºç‰Œ
                sendPlay(cardIds, null);
            }
        }
        
        function showColorModal(allowedColors) {
            const all = ['red', 'blue', 'green', 'yellow'];
            all.forEach(c => {
                const btn = document.getElementById(`modal-btn-${c}`);
                if (allowedColors.includes(c)) {
                    btn.classList.remove('disabled');
                } else {
                    btn.classList.add('disabled');
                }
            });
            document.getElementById('color-modal').style.display = 'flex';
        }

        function selectColor(color) {
            if (pendingPlayData && socket) {
                sendPlay(pendingPlayData, color);
                closeColorModal();
            }
        }

        function sendPlay(ids, color) {
            if(!socket || isProcessing) return;
            lockInterface();
            socket.emit('playCard', { cardIds: ids, chooseColor: color });
            selectedCards.clear();
            updatePlayButton();
        }

        function closeColorModal() {
            document.getElementById('color-modal').style.display = 'none';
            pendingPlayData = null;
        }

        function lockInterface() {
            isProcessing = true;
            document.getElementById('my-hand').classList.add('processing');
        }
        function unlockInterface() {
            isProcessing = false;
            document.getElementById('my-hand').classList.remove('processing');
        }

        function selectRoom(id) {
            document.getElementById('room-id').value = id;
            const input = document.getElementById('room-id');
            input.style.backgroundColor = '#444';
            setTimeout(() => input.style.backgroundColor = '#fff', 200);
        }

        try { socket = io('https://uno.ttctv-105.cc'); } catch (e) {
            document.getElementById('lobby-list').innerHTML = '<div style="color:red">ç„¡æ³•é€£æ¥ä¼ºæœå™¨</div>';
        }

        if (socket) {
            socket.on('connect', () => { myId = socket.id; });
            socket.on('joinSuccess', (roomId) => {
                document.getElementById('join-form').style.display = 'none';
                document.getElementById('wait-msg').style.display = 'block';
                document.getElementById('start-btn').style.display = 'none'; 
                document.getElementById('leave-btn').style.display = 'inline-block';
                document.getElementById('current-room-display').innerText = roomId;
                document.getElementById('chat-wrapper').style.display = 'flex';
            });
            socket.on('leftGameSuccess', () => {
                document.getElementById('join-form').style.display = 'flex';
                document.getElementById('wait-msg').style.display = 'none';
                document.getElementById('start-btn').style.display = 'none';
                document.getElementById('leave-btn').style.display = 'none';
                document.getElementById('game-screen').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('chat-wrapper').style.display = 'none';
                document.getElementById('chat-messages').innerHTML = '';
                selectedCards.clear(); updatePlayButton(); unlockInterface();
            });
            socket.on('receiveMessage', (data) => {
                appendMessage(data.name, data.text, data.name === document.getElementById('username').value);
            });
            socket.on('roomListUpdate', (list) => {
                const container = document.getElementById('lobby-list');
                container.innerHTML = '';
                if (!list || list.length === 0) {
                    container.innerHTML = '<div style="color:#777; font-size:14px; text-align:center">æš«ç„¡æˆ¿é–“ï¼Œè«‹è‡ªè¡Œå‰µå»º</div>';
                    return;
                }
                list.forEach(room => {
                    const isFull = room.count >= 10;
                    const isPlaying = room.status === 'Playing';
                    const div = document.createElement('div');
                    div.className = `room-item ${isFull ? 'full' : ''}`;
                    if (!isFull && !isPlaying) div.onclick = () => selectRoom(room.id);
                    const statusClass = isPlaying ? 'status-play' : 'status-wait';
                    const statusText = isPlaying ? 'éŠæˆ²ä¸­' : 'ç­‰å¾…ä¸­';
                    div.innerHTML = `<div>ğŸ  ${room.id} <span class="room-status ${statusClass}">${statusText}</span></div><div style="font-size:12px">ğŸ‘¤ ${room.count}/10</div>`;
                    container.appendChild(div);
                });
            });
            
            socket.on('updatePlayerList', (players) => {
                const msgEl = document.getElementById('wait-msg');
                if(msgEl) msgEl.innerText = `æˆ¿é–“äººæ•¸: ${players.map(p=>p.name).join(', ')} (${players.length}/10)`;
                const btn = document.getElementById('start-btn');
                if(players.length >= 2) btn.style.display = 'inline-block';
                else btn.style.display = 'none';
            });

            socket.on('notification', (msg) => {
                const bar = document.getElementById('notification-bar');
                bar.innerText = msg;
                bar.style.display = 'block';
                setTimeout(() => { bar.style.display = 'none'; }, 2000);
            });
            socket.on('gameStateUpdate', (state) => {
                unlockInterface();
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'flex';
                
                currentActiveColor = state.topCard.tempColor || (state.topCard.color !== 'black' ? state.topCard.color : null);

                renderDiscard(state.topCard);
                renderOpponents(state.players, state.currentPlayer);
                renderDrawButton(state.drawStack);

                const isMyTurn = state.currentPlayer === myId;
                const statusEl = document.getElementById('status-bar');
                statusEl.innerText = isMyTurn ? "ğŸ‘‰ è¼ªåˆ°ä½ äº†ï¼" : "ç­‰å¾…å°æ‰‹...";
                statusEl.style.color = isMyTurn ? "#f1c40f" : "#aaa";
                document.getElementById('direction-indicator').innerText = state.direction === 1 ? "é †æ™‚é‡ â†»" : "é€†æ™‚é‡ â†º";

                if (isMyTurn && lastActivePlayer !== myId) {
                    playTurnSound();
                }
                lastActivePlayer = state.currentPlayer;
            });
            socket.on('yourHand', (hand) => {
                window.myHandData = hand;
                const div = document.getElementById('my-hand');
                div.innerHTML = '';
                hand.forEach(c => {
                    const el = createCardEl(c);
                    if (selectedCards.has(c.id)) el.classList.add('selected');
                    el.onclick = () => toggleCardSelection(c.id, el);
                    div.appendChild(el);
                });
                updatePlayButton();
            });
            socket.on('gameOver', (msg) => { 
                document.getElementById('winner-text').innerText = msg;
                document.getElementById('game-over-modal').style.display = 'flex';
            });
            socket.on('errorMsg', (msg) => { alert(msg); unlockInterface(); });
        }

        function renderDrawButton(stack) {
            const btn = document.getElementById('draw-btn');
            const txt = document.getElementById('draw-text');
            const sub = document.getElementById('draw-sub');
            if (stack > 0) {
                btn.classList.add('penalty');
                txt.innerText = `âš ï¸`;
                sub.innerText = `é ˜å– (+${stack})`;
                sub.style.color = '#e74c3c';
                sub.style.fontWeight = 'bold';
            } else {
                btn.classList.remove('penalty');
                txt.innerText = `PASS`;
                sub.innerText = `(æŠ½ç‰Œ)`;
                sub.style.color = '#aaa';
                sub.style.fontWeight = 'normal';
            }
        }

        function createCardEl(c) {
            const div = document.createElement('div');
            div.className = `card ${c.color}`;
            let display = c.value;
            let sub = "";
            if(c.type === 'draw2') display = '+2';
            if(c.type === 'draw4') { display = '+4'; sub = "Wild"; }
            if(c.type === 'skip') display = 'âŠ˜';
            if(c.type === 'reverse') display = 'â‡„';
            if(c.type === 'wild') { display = 'ğŸŒˆ'; sub = "Wild"; } 
            div.innerHTML = `<div>${display}</div>${sub ? `<small>${sub}</small>` : ''}`;
            return div;
        }

        function renderDiscard(card) {
            const pile = document.getElementById('discard');
            pile.className = `card ${card.color}`;
            let activeColor = card.tempColor || (card.color !== 'black' ? card.color : null);
            if (activeColor) {
                pile.style.borderColor = getHexColor(activeColor);
                pile.style.boxShadow = `0 0 20px ${getHexColor(activeColor)}`;
            } else {
                pile.style.borderColor = 'white';
                pile.style.boxShadow = '3px 3px 8px rgba(0,0,0,0.6)';
            }
            let display = card.value;
            let sub = "";
            if(card.type === 'draw2') display = '+2';
            if(card.type === 'draw4') { display = '+4'; sub = "Wild"; }
            if(card.type === 'skip') display = 'âŠ˜';
            if(card.type === 'reverse') display = 'â‡„';
            if(card.type === 'wild') { display = 'ğŸŒˆ'; sub = "Wild"; }
            pile.innerHTML = `<div>${display}</div>${sub ? `<small>${sub}</small>` : ''}`;
            const hint = document.getElementById('color-hint');
            if (activeColor) {
                hint.style.display = 'block';
                hint.innerText = `ç•¶å‰é¡è‰²: ${getColorName(activeColor)}`;
                hint.style.color = getHexColor(activeColor);
            } else {
                hint.style.display = 'none';
            }
        }

        function renderOpponents(players, currentId) {
            const div = document.getElementById('opponents');
            div.innerHTML = '';
            players.forEach(p => {
                if(p.id === myId) return;
                const el = document.createElement('div');
                el.className = `opp ${p.id === currentId ? 'active' : ''}`;
                el.innerHTML = `<div>${p.name}</div><div style="font-size:18px">ğŸ‚  ${p.handCount}</div>`;
                div.appendChild(el);
            });
        }

        function getHexColor(c) {
            if(c === 'red') return '#ff5555';
            if(c === 'blue') return '#5555ff';
            if(c === 'green') return '#55aa55';
            if(c === 'yellow') return '#ffaa00';
            return 'white';
        }
        function getColorName(c) {
            if(c === 'red') return 'ç´…è‰²';
            if(c === 'blue') return 'è—è‰²';
            if(c === 'green') return 'ç¶ è‰²';
            if(c === 'yellow') return 'é»ƒè‰²';
            return c;
        }
    </script>
</body>
</html>
